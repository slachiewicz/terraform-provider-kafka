name: test

on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.x
      - run: make test

  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: 1.24.x
      - uses: actions/checkout@v4
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6

  acctest:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kafka-version: ['3.9.1', '4.1.0']
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.x
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Bring up kafka cluster (${{ matrix.kafka-version }})
        run: KAFKA_VERSION=${{ matrix.kafka-version }} docker compose up -d --wait
      - name: "Run tests (${{ matrix.kafka-version }})"
        # Limit parallelism to reduce "text file busy" errors from terraform-plugin-sdk
        # and retry on failure to handle intermittent CI issues
        run: |
          set +e
          for i in 1 2 3; do
            echo "Test attempt $i of 3"
            sleep 10
            GOMAXPROCS=2 make testacc
            exit_code=$?
            if [ $exit_code -eq 0 ]; then
              echo "Tests passed on attempt $i"
              exit 0
            fi
            echo "Tests failed on attempt $i with exit code $exit_code"
            if [ $i -lt 3 ]; then
              echo "Retrying in 5 seconds..."
              sleep 5
            fi
          done
          echo "Tests failed after 3 attempts"
          exit $exit_code
